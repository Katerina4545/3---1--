#include <pthread.h>#include <stdlib.h>#include <stdio.h>#include <errno.h>#include "../resource_manager/resource_manager.h"#define MUTEX_CNT 3#define FALSE 0#define TRUE 1#define ESUCCESS 0#define PRINT_LINES_COUNT 10#define FIRST_MUTEX_ID 0#define LAST_MUTEX_ID (MUTEX_CNT-1)#define MAIN_THREAD_START_LOCK_MUTEX_ID 0#define CHILD_THREAD_START_LOCK_MUTEX_ID 2struct thread_params {    pthread_mutex_t* in_print_sync_mutexes;    char* in_print_msg_format;    int in_start_lock_mutex_id;    int in_should_lock_first_time;    int* in_out_child_thread_locked_mutex;};void go_to_next_mutex_id_cyclic(int* mutex_id, int first_mutex_id, int last_mutex_id) {    if ((*mutex_id)==last_mutex_id) {        (*mutex_id) = first_mutex_id;    }  else {        (*mutex_id)++;    }}void *print_thread_routine(void *arg) {    struct thread_params* thread_params = (struct thread_params*) arg;    pthread_mutex_t* print_sync_mutexes = thread_params->in_print_sync_mutexes;    char* print_msg_format = thread_params->in_print_msg_format;    int cur_lock_mutex_id = thread_params->in_start_lock_mutex_id;    if (thread_params->in_should_lock_  first_time) {        int pthread_mutex_lock_result = pthread_mutex_lock(&print_sync_mutexes[cur_lock_mutex_id]);        if (pthread_mutex_lock_result!=ESUCCESS) {            errno = pthread_mutex_lock_result;            perror("pthread_mutex_lock");        }    }    if (thread_params->in_out_child_thread_locked_mutex) {        *(thread_params->in_out_child_thread_locked_mutex) = TRUE;    }    int cur_unlock_mutex_id = cur_lock_mutex_id;    go_to_next_mutex_id_cyclic(&cur_lock_mutex_id, FIRST_MUTEX_ID, LAST_MUTEX_ID);    for (int i=1;i<=PRINT_LINES_COUNT;i++) {        int pthread_mutex_lock_result = pthread_mutex_lock(&print_sync_mutexes[cur_lock_mutex_id]);        if (pthread_mutex_lock_result!=ESUCCESS) {            errno = pthread_mutex_lock_result;            perror("pthread_mutex_lock");        }        int printf_result = printf(print_msg_format, i);        if (printf_result<0) {            perror("printf");        }        int pthread_mutex_unlock_result = pthread_mutex_unlock(&print_sync_mutexes[cur_unlock_mutex_id]);        if (pthread_mutex_unlock_result!=ESUCCESS) {            errno = pthread_mutex_unlock_result;            perror("pthread_mutex_unlock");        }        go_to_next_mutex_id_cyclic(&cur_lock_mutex_id, FIRST_MUTEX_ID, LAST_MUTEX_ID);        go_to_next_mutex_id_cyclic(&cur_unlock_mutex_id, FIRST_MUTEX_ID, LAST_MUTEX_ID);    }    int pthread_mutex_unlock_result = pthread_mutex_unlock(&print_sync_mutexes[cur_unlock_mutex_id]);    if (pthread_mutex_unlock_result!=ESUCCESS) {        errno = pthread_mutex_unlock_result;        perror("pthread_mutex_unlock");    }}int create_mutexes_or_rollback(rm_rollback_point* start_rollback_point, pthread_mutex_t* mutexes, int mutexes_count) {    pthread_mutexattr_t mutex_attr;    int pthread_mutexattr_init_result = pthread_mutexattr_init(&mutex_attr);    if (pthread_mutexattr_init_result!=ESUCCESS) {        errno = pthread_mutexattr_init_result;        perror("pthread_mutexattr_init");        rm_rollback(start_rollback_point);        return EXIT_FAILURE;    }    int pthread_mutexattr_settype_result = pthread_mutexattr_settype(&mutex_attr, PTHREAD_MUTEX_ERRORCHECK);    if (pthread_mutexattr_settype_result!=ESUCCESS) {        errno = pthread_mutexattr_settype_result;        perror("pthread_mutexattr_settype");    }    for (int i=0;i<mutexes_count;i++) {        int pthread_mutex_init_result = rm_pthread_mutex_init(&mutexes[i], &mutex_attr);        if (pthread_mutex_init_result!=ESUCCESS) {            errno = pthread_mutex_init_result;            perror("pthread_mutex_init");            rm_rollback(start_rollback_point);            int pthread_mutexattr_destroy_result = pthread_mutexattr_destroy(&mutex_attr);            if (pthread_mutexattr_destroy_result!=ESUCCESS) {                errno = pthread_mutexattr_destroy_result;                perror("pthread_mutexattr_destroy");            }            return EXIT_FAILURE;        }    }    int pthread_mutexattr_destroy_result = pthread_mutexattr_destroy(&mutex_attr);    if (pthread_mutexattr_destroy_result!=ESUCCESS) {        errno = pthread_mutexattr_destroy_result;        perror("pthread_mutexattr_destroy");    }    return ESUCCESS;}void fill_threads_params(struct thread_params *params_main_thread, struct thread_params *params_child_thread,                         char *print_msg_format_main_thread,  char* print_msg_format_child_thread, int* is_child_initialized, pthread_mutex_t* print_sync_mutexes) {    params_main_thread->in_print_sync_mutexes = params_child_thread->in_print_sync_mutexes = print_sync_mutexes;    params_main_thread->in_start_lock_mutex_id = MAIN_THREAD_START_LOCK_MUTEX_ID;    params_child_thread->in_start_lock_mutex_id = CHILD_THREAD_START_LOCK_MUTEX_ID;    params_main_thread->in_print_msg_format = print_msg_format_main_thread;    params_child_thread->in_print_msg_format = print_msg_format_child_thread;    params_main_thread->in_should_lock_first_time = FALSE;    params_child_thread->in_should_lock_first_time = TRUE;    params_main_thread->in_out_child_thread_locked_mutex = NULL;    params_child_thread->in_out_child_thread_locked_mutex = is_child_initialized;}int main(int argc, char** argv) {    rm_rollback_point start_rollback_point;    int rm_mk_rollback_point_result = rm_mk_rollback_point(&start_rollback_point);    if (rm_mk_rollback_point_result!=ESUCCESS) {        perror("rm_mk_rollback_point");        return EXIT_FAILURE;    }    pthread_mutex_t print_sync_mutexes[MUTEX_CNT];    int create_mutexes_or_rollback_result = create_mutexes_or_rollback(&start_rollback_point, print_sync_mutexes, MUTEX_CNT);    if (create_mutexes_or_rollback_result!=ESUCCESS) {        return create_mutexes_or_rollback_result;    }    pthread_t child_thread;    struct thread_params params_main_thread, params_child_thread;    int is_child_initialized = FALSE;    char print_msg_format_main_thread[] = "Main thread message #%d\n";    char print_msg_format_child_thread[] = "Print thread message #%d\n";    fill_threads_params(&params_main_thread, &params_child_thread, print_msg_format_main_thread, print_msg_format_child_thread, &is_child_initialized, print_sync_mutexes);    int pthread_mutex_lock_result = pthread_mutex_lock(&print_sync_mutexes[MAIN_THREAD_START_LOCK_MUTEX_ID]);    if (pthread_mutex_lock_result!=ESUCCESS) {        errno = pthread_mutex_lock_result;        perror("pthread_mutex_lock");    }    int pthread_create_result = pthread_create(&child_thread, NULL, print_thread_routine, &params_child_thread);    if (pthread_create_result!=ESUCCESS) {        errno = pthread_create_result;        perror("pthread_create");        rm_rollback(&start_rollback_point);        return EXIT_FAILURE;    }    while (!is_child_initialized) {        int pthread_yield_result = pthread_yield();        if (pthread_yield_result!=ESUCCESS) {            perror("pthread_yield");        }    }    print_thread_routine(&params_main_thread);    void* child_thread_result_ignored;    int pthread_join_result = pthread_join(child_thread, &child_thread_result_ignored); //only EINVAL    if (pthread_join_result!=ESUCCESS) {        errno = pthread_join_result;        perror("pthread_join");    }    rm_rollback(&start_rollback_point);    return EXIT_SUCCESS;}